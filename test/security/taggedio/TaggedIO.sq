{- TaggedIO -}

data TaggedIO a <visibleTo :: User -> Bool>

-- primitives

returnIO :: x:a -> TaggedIO {a | _v == x} <{False}>
joinIO :: <p :: User -> Bool> . TaggedIO (TaggedIO a <p>) <p> -> TaggedIO a <p>
mapIO :: <p :: User -> Bool> . (a -> b) -> TaggedIO a <p> -> TaggedIO b <p>

flip :: <p :: User -> Bool> . Tagged (TaggedIO a <p>) <p> -> TaggedIO (Tagged a <p>) <p>

-- non-primitives

bind2 :: <p :: User -> Bool> .
    Tagged a <p> ->
    (a -> TaggedIO b <p>) ->
    TaggedIO (Tagged b <p>) <p>
bind2 = \a . \f . flip (bind a (\t . return (f t)))

bindIO :: <p :: User -> Bool> .
    TaggedIO a <p> ->
    (a -> TaggedIO b <p>) ->
    TaggedIO b <p>
bindIO = \a . \f . joinIO (mapIO f a)

ifIO :: <b :: Bool> . <t :: User -> Bool> . <bc :: User -> Bool> .
    cond: Tagged {Bool | (_v ==> b)} <bc> ->
    TaggedIO (Tagged a <bc>) <{t _0 && b && bc _0}> ->
    TaggedIO (Tagged a <bc>) <{t _0 && bc _0}> ->
    TaggedIO (Tagged a <bc>) <t>
ifIO = \cond . \a . \b . (bind2 cond (\c . (if c then a else b)))

ifIO_ :: <b :: Bool> . <t :: User -> Bool> . <bc :: User -> Bool> .
    cond: Tagged {Bool | (_v ==> b)} <bc> ->
    TaggedIO a <{t _0 && b && bc _0}> ->
    TaggedIO a2 <{t _0 && bc _0}> ->
    TaggedIO Unit <t>
ifIO_ = \cond . \a . \b .
    bindIO (
      ifIO cond
        (bindIO a (\blah . returnIO (return Unit)))
        (bindIO b (\blah . returnIO (return Unit)))
    ) (\blah . returnIO (return Unit))

{-
ifIO :: <b :: Bool> . <t :: User -> Bool> .
    cond: Tagged {Bool | (_v == b)} <{b && t _0}> ->
    TaggedIO a <{t _0 && b}> ->
    TaggedIO a <{t _0 && !b}> ->
    TaggedIO a <t>
-}

-- gets the 'disjunctive right-hand-side' error
{-
ifIO :: <b :: Bool> . <t :: User -> Bool> . <notb :: Bool> .
    cond: Tagged {Bool | (_v ==> b) && ((!_v) ==> notb)} <{b && t _0}> ->
    TaggedIO a <{t _0 && b}> ->
    TaggedIO a <{t _0 && notb}> ->
    TaggedIO a <t>
-}

-- what I want the sound version to look like

{-
ifIO :: <b :: Bool> . <t :: User -> Bool> . <r :: User -> Bool>
    cond: Tagged {Bool | (_v == b)} <{b && t _0}> ->
    TaggedIO (Tagged a <{b && r _0}>) <{t _0 && b}> ->
    TaggedIO (Tagged a <r>) <{t _0 && !b}> ->
    TaggedIO (Tagged a <r>) <t>
-}


print :: <pp :: User -> Bool> .
    Tagged {User | pp _v} <pp> ->
    Tagged String <pp> ->
    TaggedIO Unit <pp>
