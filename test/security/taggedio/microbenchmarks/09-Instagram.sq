{- 
  The James Comey Instagram leak: the follow-relationships of private accounts leaks through recommendation algorithms
-}

{- Datatypes -}

data Store

{- Sensitive data and policies -}

getAllUsers :: ds: Store -> [User]

-- | User name (visible to all)
predicate name :: Store -> Map User String
getName :: ds: Store -> u: User -> TIO {String | _v == (name ds)[[u]]} <{True}> <{False}>

-- | Is user's account private? (visible to all)
predicate isPrivate :: Store -> Map User Bool
getIsPrivate :: ds: Store -> u: User -> TIO {Bool | _v == (isPrivate ds)[[u]]} <{True}> <{False}>

-- | Who this user follows (for private accounts: only visible to followers)
predicate following :: Store -> Map User (Set User)
getIsFollowing :: ds: Store -> who: User -> whom: User ->
  TIO {Bool | _v == (whom in (following ds)[[who]])} <{canSee ds _0 who && canSee ds _0 whom}> <{False}>
setIsFollowing :: ds: Store -> who: User -> whom: User -> val: Bool ->
  TIO {Store | (whom in (following _v)[[who]]) == val && name _v == name ds && isPrivate _v == isPrivate ds} <{True}> <{canSee ds _0 who && canSee ds _0 whom}>
  
-- | Is account u public? Yes if it's not private    
inline isPublic ds u = !(isPrivate ds)[[u]]    
-- | Can x see y? Yes if they are the same, y is public, or x is following y 
inline canSee ds x y  =  x == y || isPublic ds y || y in (following ds)[[x]]

{- Client code -}

-- | Show to client who friend is following
-- Repair: inside shouldRecommend, check if u is public or client is following them, otherwise return false    
showRecommendations :: ds: Store -> client: User -> newFriend: {User | isPublic ds _v && _v in (following ds)[[client]]} -> TIO Unit <{False}> <{True}>
showRecommendations = \ds . \client . \newFriend .
  do
    uids <- let shouldRecommend = \u1.
              do
                alreadyFollowing <- downgrade (getIsFollowing ds client u1)
                if u1 == client || alreadyFollowing
                  then return false -- Do not recommend following myself or people I already follow
                  else getIsFollowing ds newFriend u1 -- Recommend following everyone newFriend follows
            in filterM (\u. shouldRecommend u) (getAllUsers ds)    
    names <- mapM (\u . getName ds u) uids
    print client (unlines names)
  
-- | Follow newFriend and suggest who else to follow  
follow :: ds: Store -> client: User -> newFriend: {User | isPublic ds _v} -> TIO Unit <{False}> <{True}>
follow = \ds . \client . \newFriend .
  do
    ds' <- setIsFollowing ds client newFriend true
    showRecommendations ds' client newFriend
    
