defaultPsychiatristPatients :: Tagged List User <True>
defaultPsychiatristPatients =
return Nil

defaultDoctorPatients :: Tagged List User <True>
defaultDoctorPatients = return
                          Nil

showRecordByIdView :: w:World -> rid:RecordId -> World
showRecordByIdView = \w . \rid .
    
    let u = getSessionUser w in
    
    let record = ifM (bind u (\x8 .
                          bind (getRecord w rid) (\x7 .
                              bind (getAuthor x7) (\x6 .
                                  return (eq x8 x6))))) (getRecord
                                                           w rid) (ifM (andM
                                                                          (bind
                                                                             u
                                                                             (\x20 .
                                                                               bind
                                                                                 (getRecord
                                                                                    w
                                                                                    rid)
                                                                                 (\x19 .
                                                                                   bind
                                                                                     (getShouldWithhold
                                                                                        x20
                                                                                        x19)
                                                                                     (\x18 .
                                                                                       return
                                                                                         (not
                                                                                            x18)))))
                                                                          (bind
                                                                             u
                                                                             (\x22 .
                                                                               bind
                                                                                 (getIsDoctor
                                                                                    w
                                                                                    x22)
                                                                                 (\x21 .
                                                                                   return
                                                                                     x21))))
                                                                     (getRecord
                                                                        w rid)
                                                                     (ifM (andM
                                                                             (andM
                                                                                (bind
                                                                                   u
                                                                                   (\x40 .
                                                                                     bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x39 .
                                                                                         bind
                                                                                           (getShouldWithhold
                                                                                              x40
                                                                                              x39)
                                                                                           (\x38 .
                                                                                             return
                                                                                               (not
                                                                                                  x38)))))
                                                                                (bind
                                                                                   u
                                                                                   (\x43 .
                                                                                     bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x42 .
                                                                                         bind
                                                                                           (getPatient
                                                                                              x42)
                                                                                           (\x41 .
                                                                                             return
                                                                                               (eq
                                                                                                  x43
                                                                                                  x41))))))
                                                                             (bind
                                                                                u
                                                                                (\x45 .
                                                                                  bind
                                                                                    (getIsPatient
                                                                                       w
                                                                                       x45)
                                                                                    (\x44 .
                                                                                      return
                                                                                        x44))))
                                                                        (getRecord
                                                                           w
                                                                           rid)
                                                                        (ifM
                                                                           (andM
                                                                              (andM
                                                                                 (andM
                                                                                    (bind
                                                                                       u
                                                                                       (\x66 .
                                                                                         bind
                                                                                           (getRecord
                                                                                              w
                                                                                              rid)
                                                                                           (\x65 .
                                                                                             bind
                                                                                               (getShouldWithhold
                                                                                                  x66
                                                                                                  x65)
                                                                                               (\x64 .
                                                                                                 return
                                                                                                   (not
                                                                                                      x64)))))
                                                                                    (bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x68 .
                                                                                         bind
                                                                                           (getIsPsychiatricRecord
                                                                                              x68)
                                                                                           (\x67 .
                                                                                             return
                                                                                               x67))))
                                                                                 (bind
                                                                                    u
                                                                                    (\x70 .
                                                                                      bind
                                                                                        (getIsPsychiatrist
                                                                                           w
                                                                                           x70)
                                                                                        (\x69 .
                                                                                          return
                                                                                            x69))))
                                                                              (bind
                                                                                 u
                                                                                 (\x74 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x73 .
                                                                                       bind
                                                                                         (getPatient
                                                                                            x73)
                                                                                         (\x72 .
                                                                                           bind
                                                                                             (getIsTreating
                                                                                                x74
                                                                                                x72)
                                                                                             (\x71 .
                                                                                               return
                                                                                                 x71))))))
                                                                           (getRecord
                                                                              w
                                                                              rid)
                                                                           defaultRecord)))
      in
    print w u (liftM show record)

showRecordsForPatientView :: w:World -> p:User -> World
showRecordsForPatientView = \w .
  \patientToSearchFor . 
    let sessionUser = getSessionUser
                        w in
    
    let recordIds = getAllRecordIds
                      w in
    
    let records = sequence (map
                              (\rid . ifM (bind sessionUser
                                             (\x8 . bind (getRecord w rid)
                                                      (\x7 . bind (getAuthor x7)
                                                               (\x6 . return (eq
                                                                                x8
                                                                                x6)))))
                                        (getRecord w rid) (ifM (andM
                                                                  (bind
                                                                     sessionUser
                                                                     (\x20 .
                                                                       bind
                                                                         (getRecord
                                                                            w
                                                                            rid)
                                                                         (\x19 .
                                                                           bind
                                                                             (getShouldWithhold
                                                                                x20
                                                                                x19)
                                                                             (\x18 .
                                                                               return
                                                                                 (not
                                                                                    x18)))))
                                                                  (bind
                                                                     sessionUser
                                                                     (\x22 .
                                                                       bind
                                                                         (getIsDoctor
                                                                            w
                                                                            x22)
                                                                         (\x21 .
                                                                           return
                                                                             x21))))
                                                             (getRecord w rid)
                                                             (ifM (andM (andM
                                                                           (bind
                                                                              sessionUser
                                                                              (\x40 .
                                                                                bind
                                                                                  (getRecord
                                                                                     w
                                                                                     rid)
                                                                                  (\x39 .
                                                                                    bind
                                                                                      (getShouldWithhold
                                                                                         x40
                                                                                         x39)
                                                                                      (\x38 .
                                                                                        return
                                                                                          (not
                                                                                             x38)))))
                                                                           (bind
                                                                              sessionUser
                                                                              (\x43 .
                                                                                bind
                                                                                  (getRecord
                                                                                     w
                                                                                     rid)
                                                                                  (\x42 .
                                                                                    bind
                                                                                      (getPatient
                                                                                         x42)
                                                                                      (\x41 .
                                                                                        return
                                                                                          (eq
                                                                                             x43
                                                                                             x41))))))
                                                                     (bind
                                                                        sessionUser
                                                                        (\x45 .
                                                                          bind
                                                                            (getIsPatient
                                                                               w
                                                                               x45)
                                                                            (\x44 .
                                                                              return
                                                                                x44))))
                                                                (getRecord w
                                                                   rid) (ifM
                                                                           (andM
                                                                              (andM
                                                                                 (andM
                                                                                    (bind
                                                                                       sessionUser
                                                                                       (\x66 .
                                                                                         bind
                                                                                           (getRecord
                                                                                              w
                                                                                              rid)
                                                                                           (\x65 .
                                                                                             bind
                                                                                               (getShouldWithhold
                                                                                                  x66
                                                                                                  x65)
                                                                                               (\x64 .
                                                                                                 return
                                                                                                   (not
                                                                                                      x64)))))
                                                                                    (bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x68 .
                                                                                         bind
                                                                                           (getIsPsychiatricRecord
                                                                                              x68)
                                                                                           (\x67 .
                                                                                             return
                                                                                               x67))))
                                                                                 (bind
                                                                                    sessionUser
                                                                                    (\x70 .
                                                                                      bind
                                                                                        (getIsPsychiatrist
                                                                                           w
                                                                                           x70)
                   WARNING: cannot abduce a condition for violation
  getRecord w' rid ::
  Tagged Record <_1 == sessionUser _0 && sessionUser _0 == sessionUser w>
  Probable cause: missing condition qualifiers
                                                                     (\x69 .
                                                                                          return
                                                                                            x69))))
                                                                              (bind
                                                                                 sessionUser
                                                                                 (\x74 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x73 .
                                                                                       bind
                                                                                         (getPatient
                                                                                            x73)
                                                                                         (\x72 .
                                                                                           bind
                                                                                             (getIsTreating
                                                                                                x74
                                                                                                x72)
                                                                                             (\x71 .
                                                                                               return
                                                                                                 x71))))))
                                                                           (getRecord
                                                                              w
                                                                              rid)
                                                                           defaultRecord))))
                              recordIds) in
    
    let recordsForPatient = bind
                              records (filterM (\record . bind
                                                            (getPatient record)
                                                            (\x . return (x ==
                                                                            patientToSearchFor))))
      in
    print w sessionUser (liftM show
                           recordsForPatient)

showAuthoredRecordsView :: w:World -> World
showAuthoredRecordsView = \w . 
  let sessionUser = getSessionUser
                      w in
  
  let recordIds = bind sessionUser
                    (\user . return
                               (getAuthoredRecordIds w user))
    in
  
  let records = bind recordIds
                  (\rids . mapM (\rid . getRecord
                                          w rid) rids) in
  print w sessionUser (liftM show
                         records)

updateRecordForm :: w:World -> rid:RecordId -> record:Record -> World
updateRecordForm = \w . \rid .
    \record . 
      let w' = setRecord w rid (return
                                  record) in
      
      let newRecord = defaultRecord in
      
      let u = getSessionUser w' in
      print w' u (liftM show
                    newRecord)

listOfPatientsView :: w:World -> World
listOfPatientsView = \w . 
  let sessionUser = getSessionUser
                      w in
  
  let patients1 = bind sessionUser
                    (\u . ifM (bind sessionUser
                                 (\x4 . bind (getIsPsychiatrist w
                                                x4) (\x3 . return x3)))
                            (getPsychiatristPatients u)
                            defaultPsychiatristPatients) in
  
  let patients2 = bind sessionUser
                    (\u . ifM (bind sessionUser
                                 (\x9 . bind (getIsDoctor w x9)
                                          (\x8 . return x8)))
                            (getDoctorPatients u)
                            defaultDoctorPatients) in
  
  let patients = bind patients1
                   (\p1 . bind patients2 (\p2 .
                              return (concat p1 p2))) in
  print w sessionUser (liftM show
                         patients)

(Goals: 7)
(Measures: 3)
(Policy size: fromList [("../paperWrites/Prelude.sq",20),("../paperWrites/Tagged.sq",123),("HealthWeb.sq",194)])
Goal                  &     Templ  &  Solution  &   Time: Typecheck  &     Repair  &    Recheck  &  Total Synth  \\
defaultPsychiatristPatients  &         3  &         3  &             0.00s  &      0.00s  &      0.00s  &        0.00s  \\
defaultDoctorPatients  &         3  &         3  &             0.00s  &      0.00s  &      0.00s  &        0.00s  \\
showRecordByIdView    &        23  &       316  &             0.00s  &      6.04s  &      6.06s  &       12.11s  \\
showRecordsForPatientView  &        56  &       349  &             0.03s  &      6.74s  &      6.36s  &       13.14s  \\
showAuthoredRecordsView  &        45  &        45  &             0.02s  &      0.00s  &      0.00s  &        0.02s  \\
updateRecordForm      &        34  &        30  &             0.00s  &      0.15s  &      0.00s  &        0.15s  \\
listOfPatientsView    &        52  &        96  &             0.03s  &      0.07s  &      0.02s  &        0.13s  \\
Totals                &       216  &       842  &             0.10s  &     13.01s  &     12.45s  &       25.57s  \\
