showRecord :: w:World -> rid:RecordId -> World
showRecord = \w . \rid . 
    let u = getSessionUser w in
    
    let record = ifM (bind u (\x8 .
                          bind (getRecord w rid) (\x7 .
                              bind (getAuthor x7) (\x6 .
                                  return (eq x8 x6))))) (getRecord
                                                           w rid) (ifM (andM
                                                                          (bind
                                                                             u
                                                                             (\x20 .
                                                                               bind
                                                                                 (getRecord
                                                                                    w
                                                                                    rid)
                                                                                 (\x19 .
                                                                                   bind
                                                                                     (getShouldWithhold
                                                                                        x20
                                                                                        x19)
                                                                                     (\x18 .
                                                                                       return
                                                                                         (not
                                                                                            x18)))))
                                                                          (bind
                                                                             u
                                                                             (\x22 .
                                                                               bind
                                                                                 (getIsDoctor
                                                                                    w
                                                                                    x22)
                                                                                 (\x21 .
                                                                                   return
                                                                                     x21))))
                                                                     (getRecord
                                                                        w rid)
                                                                     (ifM (andM
                                                                             (andM
                                                                                (bind
                                                                                   u
                                                                                   (\x40 .
                                                                                     bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x39 .
                                                                                         bind
                                                                                           (getShouldWithhold
                                                                                              x40
                                                                                              x39)
                                                                                           (\x38 .
                                                                                             return
                                                                                               (not
                                                                                                  x38)))))
                                                                                (bind
                                                                                   u
                                                                                   (\x43 .
                                                                                     bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x42 .
                                                                                         bind
                                                                                           (getPatient
                                                                                              x42)
                                                                                           (\x41 .
                                                                                             return
                                                                                               (eq
                                                                                                  x43
                                                                                                  x41))))))
                                                                             (bind
                                                                                u
                                                                                (\x45 .
                                                                                  bind
                                                                                    (getIsPatient
                                                                                       w
                                                                                       x45)
                                                                                    (\x44 .
                                                                                      return
                                                                                        x44))))
                                                                        (getRecord
                                                                           w
                                                                           rid)
                                                                        (ifM
                                                                           (andM
                                                                              (andM
                                                                                 (andM
                                                                                    (bind
                                                                                       u
                                                                                       (\x66 .
                                                                                         bind
                                                                                           (getRecord
                                                                                              w
                                                                                              rid)
                                                                                           (\x65 .
                                                                                             bind
                                                                                               (getShouldWithhold
                                                                                                  x66
                                                                                                  x65)
                                                                                               (\x64 .
                                                                                                 return
                                                                                                   (not
                                                                                                      x64)))))
                                                                                    (bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x68 .
                                                                                         bind
                                                                                           (getIsPsychiatricRecord
                                                                                              x68)
                                                                                           (\x67 .
                                                                                             return
                                                                                               x67))))
                                                                                 (bind
                                                                                    u
                                                                                    (\x70 .
                                                                                      bind
                                                                                        (getIsPsychiatrist
                                                                                           w
                                                                                           x70)
                                                                                        (\x69 .
                                                                                          return
                                                                                            x69))))
                                                                              (bind
                                                                                 u
                                                                                 (\x74 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x73 .
                                                                                       bind
                                                                                         (getPatient
                                                                                            x73)
                                                                                         (\x72 .
                                                                                           bind
                                                                                             (getIsTreating
                                                                                                x74
                                                                                                x72)
                                                                                             (\x71 .
                                                                                               return
                                                                                                 x71))))))
                                                                           (getRecord
                                                                              w
                                                                              rid)
                                                                           defaultRecord)))
      in
    print w u (liftM show record)

showRecordForPatient :: w:World -> p:User -> World
showRecordForPatient = \w .
  \patientToSearchFor . 
    let sessionUser = getSessionUser
                        w in
    
    let recordIds = getAllRecordIds
                      w in
    
    let records = sequence (map
                              (\rid . ifM (bind sessionUser
                                             (\x8 . bind (getRecord w rid)
                                                      (\x7 . bind (getAuthor x7)
                                                               (\x6 . return (eq
                                                                                x8
                                                                                x6)))))
                                        (getRecord w rid) (ifM (andM
                                                                  (bind
                                                                     sessionUser
                                                                     (\x20 .
                                                                       bind
                                                                         (getRecord
                                                                            w
                                                                            rid)
                                                                         (\x19 .
                                                                           bind
                                                                             (getShouldWithhold
                                                                                x20
                                                                                x19)
                                                                             (\x18 .
                                                                               return
                                                                                 (not
                                                                                    x18)))))
                                                                  (bind
                                                                     sessionUser
                                                                     (\x22 .
                                                                       bind
                                                                         (getIsDoctor
                                                                            w
                                                                            x22)
                                                                         (\x21 .
                                                                           return
                                                                             x21))))
                                                             (getRecord w rid)
                                                             (ifM (andM (andM
                                                                           (bind
                                                                              sessionUser
                                                                              (\x40 .
                                                                                bind
                                                                                  (getRecord
                                                                                     w
                                                                                     rid)
                                                                                  (\x39 .
                                                                                    bind
                                                                                      (getShouldWithhold
                                                                                         x40
                                                                                         x39)
                                                                                      (\x38 .
                                                                                        return
                                                                                          (not
                                                                                             x38)))))
                                                                           (bind
                                                                              sessionUser
                                                                              (\x43 .
                                                                                bind
                                                                                  (getRecord
                                                                                     w
                                                                                     rid)
                                                                                  (\x42 .
                                                                                    bind
                                                                                      (getPatient
                                                                                         x42)
                                                                                      (\x41 .
                                                                                        return
                                                                                          (eq
                                                                                             x43
                                                                                             x41))))))
                                                                     (bind
                                                                        sessionUser
                                                                        (\x45 .
                                                                          bind
                                                                            (getIsPatient
                                                                               w
                                                                               x45)
                                                                            (\x44 .
                                                                              return
                                                                                x44))))
                                                                (getRecord w
                                                                   rid) (ifM
                                                                           (andM
                                                                              (andM
                                                                                 (andM
                                                                                    (bind
                                                                                       sessionUser
                                                                                       (\x66 .
                                                                                         bind
                                                                                           (getRecord
                                                                                              w
                                                                                              rid)
                                                                                           (\x65 .
                                                                                             bind
                                                                                               (getShouldWithhold
                                                                                                  x66
                                                                                                  x65)
                                                                                               (\x64 .
                                                                                                 return
                                                                                                   (not
                                                                                                      x64)))))
                                                                                    (bind
                                                                                       (getRecord
                                                                                          w
                                                                                          rid)
                                                                                       (\x68 .
                                                                                         bind
                                                                                           (getIsPsychiatricRecord
                                                                                              x68)
                                                                                           (\x67 .
                                                                                             return
                                                                                               x67))))
                                                                                 (bind
                                                                                    sessionUser
                                                                                    (\x70 .
                                                                                      bind
                                                                                        (getIsPsychiatrist
                                                                                           w
                                                                                           x70)
                                                                                        (\x69 .
                                                                                          return
                                                                                            x69))))
                                                                              (bind
                                                                                 sessionUser
                                                                                 (\x74 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x73 .
                                                                                       bind
                                                                                         (getPatient
                                                                                            x73)
                                                                                         (\x72 .
                                                                                           bind
                                                                                             (getIsTreating
                                                                                                x74
                                                                                                x72)
                                                                                             (\x71 .
                                                                                               return
                                                                                                 x71))))))
                                                                           (getRecord
                                                                              w
                                                                              rid)
                                                                           defaultRecord))))
                              recordIds) in
    
    let recordsForPatient = bind
                              records (filterM (\record . bind
                                                            (getPatient record)
                                                            (\x . return (x ==
                                                                            patientToSearchFor))))
      in
    print w sessionUser (liftM show
                           recordsForPatient)

(Goals: 2)
(Measures: 3)
(Policy size: fromList [("../paper/Prelude.sq",37),("../paper/Tagged.sq",115),("HealthWeb.sq",104)])
Goal                  &     Templ  &  Solution  &   Time: Typecheck  &     Repair  &    Recheck  &  Total Synth  \\
showRecord            &        23  &       316  &             0.00s  &     17.67s  &      5.64s  &       23.32s  \\
showRecordForPatient  &        56  &       349  &             0.02s  &     18.09s  &      7.71s  &       25.82s  \\
Totals                &        79  &       665  &             0.03s  &     35.76s  &     13.35s  &       49.15s  \\
