showRecordByIdView :: w:World -> rid:RecordId -> World
showRecordByIdView = \w . \rid .
    
    let u = getSessionUser w in
    
    let record = bind (downgrade
                         (bind u (\x10 . bind (getRecord
                                                 w rid) (\x9 . bind (getAuthor
                                                                       x9)
                                                                 (\x8 . return
                                                                          (eq
                                                                             x10
                                                                             x8))))))
                   (\g0 . bind (downgrade (andM
                                             (bind u (\x22 . bind (getRecord
                                                                     w rid)
                                                               (\x21 . bind
                                                                         (getShouldWithhold
                                                                            x22
                                                                            x21)
                                                                         (\x20 .
                                                                           return
                                                                             (not
                                                                                x20)))))
                                             (bind u (\x24 . bind
                                                               (getIsDoctor w
                                                                  x24) (\x23 .
                                                                 return x23)))))
                            (\g1 . bind (downgrade (andM
                                                      (andM (bind u (\x42 . bind
                                                                              (getRecord
                                                                                 w
                                                                                 rid)
                                                                              (\x41 .
                                                                                bind
                                                                                  (getShouldWithhold
                                                                                     x42
                                                                                     x41)
                                                                                  (\x40 .
                                                                                    return
                                                                                      (not
                                                                                         x40)))))
                                                         (bind u (\x45 . bind
                                                                           (getRecord
                                                                              w
                                                                              rid)
                                                                           (\x44 .
                                                                             bind
                                                                               (getPatient
                                                                                  x44)
                                                                               (\x43 .
                                                                                 return
                                                                                   (eq
                                                                                      x45
                                                                                      x43))))))
                                                      (bind u (\x47 . bind
                                                                        (getIsPatient
                                                                           w
                                                                           x47)
                                                                        (\x46 .
                                                                          return
                                                                            x46)))))
                                     (\g2 . bind (downgrade (andM
                                                               (andM (andM (bind
                                                                              u
                                                                              (\x68 .
                                                                                bind
                                                                                  (getRecord
                                                                                     w
                                                                                     rid)
                                                                                  (\x67 .
                                                                                    bind
                                                                                      (getShouldWithhold
                                                                                         x68
                                                                                         x67)
                                                                                      (\x66 .
                                                                                        return
                                                                                          (not
                                                                                             x66)))))
                                                                        (bind
                                                                           (getRecord
                                                                              w
                                                                              rid)
                                                                           (\x70 .
                                                                             bind
                                                                               (getIsPsychiatricRecord
                                                                                  x70)
                                                                               (\x69 .
                                                                                 return
                                                                                   x69))))
                                                                  (bind u
                                                                     (\x72 .
                                                                       bind
                                                                         (getIsPsychiatrist
                                                                            w
                                                                            x72)
                                                                         (\x71 .
                                                                           return
                                                                             x71))))
                                                               (bind u (\x76 .
                                                                    bind
                                                                      (getRecord
                                                                         w rid)
                                                                      (\x75 .
                                                                        bind
                                                                          (getPatient
                                                                             x75)
                                                                          (\x74 .
                                                                            bind
                                                                              (getIsTreating
                                                                                 x76
                                                                                 x74)
                                                                              (\x73 .
                                                                                return
                                                                                  x73)))))))
                                              (\g3 . 
                                                if g0 || (g1 || (g2 || g3))
                                                  then getRecord w rid
                                                  else return defaultRecord))))
      in
    print w u (liftM show record)

showRecordsForPatientView :: w:World -> p:User -> World
showRecordsForPatientView = \w .
  \patientToSearchFor . 
    let sessionUser = getSessionUser
                        w in
    
    let recordIds = getAllRecordIds
                      w in
    
    let records = sequence (map
                              (\rid . bind (downgrade (bind
                                                         sessionUser (\x10 .
                                                           bind (getRecord w
                                                                   rid) (\x9 .
                                                               bind (getAuthor
                                                                       x9)
                                                                 (\x8 . return
                                                                          (eq
                                                                             x10
                                                                             x8))))))
                                        (\g0 . bind (downgrade (andM
                                                                  (bind
                                                                     sessionUser
                                                                     (\x22 .
                                                                       bind
                                                                         (getRecord
                                                                            w
                                                                            rid)
                                                                         (\x21 .
                                                                           bind
                                                                             (getShouldWithhold
                                                                                x22
                                                                                x21)
                                                                             (\x20 .
                                                                               return
                                                                                 (not
                                                                                    x20)))))
                                                                  (bind
                                                                     sessionUser
                                                                     (\x24 .
                                                                       bind
                                                                         (getIsDoctor
                                                                            w
                                                                            x24)
                                                                         (\x23 .
                                                                           return
                                                                             x23)))))
                                                 (\g1 . bind (downgrade (andM
                                                                           (andM
                                                                              (bind
                                                                                 sessionUser
                                                                                 (\x42 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x41 .
                                                                                       bind
                                                                                         (getShouldWithhold
                                                                                            x42
                                                                                            x41)
                                                                                         (\x40 .
                                                                                           return
                                                                                             (not
                                                                                                x40)))))
                                                                              (bind
                                                                                 sessionUser
                                                                                 (\x45 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x44 .
                                                                                       bind
                                                                                         (getPatient
                                                                                            x44)
                                                                                         (\x43 .
                                                                                           return
                                                                                             (eq
                                                                                                x45
                                                                                                x43))))))
                                                                           (bind
                                                                              sessionUser
                                                                              (\x47 .
                                                                                bind
                                                                                  (getIsPatient
                                                                                     w
                                                                                     x47)
                                                                                  (\x46 .
                                                                                    return
                                                                                      x46)))))
                                                          (\g2 . bind (downgrade
                                                                         (andM
                                                                            (andM
                                                                               (andM
                                                                                  (bind
                                                                                     sessionUser
                                                                                     (\x68 .
                                                                                       bind
                                                                                         (getRecord
                                                                                            w
                                                                                            rid)
                                                                                         (\x67 .
                                                                                           bind
                                                                                             (getShouldWithhold
                                                                                                x68
                                                                                                x67)
                                                                                             (\x66 .
                                                                                               return
                                                                                                 (not
                                                                                                    x66)))))
                                                                                  (bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x70 .
                                                                                       bind
                                                                                         (getIsPsychiatricRecord
                                                                                            x70)
                                                                                         (\x69 .
                                                                                           return
                                                                                             x69))))
                                                                               (bind
                                                                                  sessionUser
                                                                                  (\x72 .
                                                                                    bind
                                                                                      (getIsPsychiatrist
                                                                                         w
                                                                                         x72)
                                                                                      (\x71 .
                                                                                        return
                                                                                          x71))))
                                                                            (bind
                                                                               sessionUser
                                                                               (\x76 .
                                                                                 bind
                                                                                   (getRecord
                                                                                      w
                                                                                      rid)
                                                                                   (\x75 .
                                                                                     bind
                                                                                       (getPatient
                                                                                          x75)
                                                                                       (\x74 .
                                                                                         bind
                                                                                           (getIsTreating
                                                                                              x76
                                                                                              x74)
                                                                                           (\x73 .
                                                                                             return
                                                                                               x73)))))))
                                                                   (\g3 . 
                                                                     if g0 ||
                                                                          (g1 ||
                                                                             (g2
                                                                                ||
                                                                                g3))
                                                                       then
                                                                         getRecord
                                                                           w rid
                                                                       else
                                                                         return
                                                                           defaultRecord)))))
                              recordIds) in
    
    let recordsForPatient = bind
                              records (filterM (\record . bind
                                                            (getPatient record)
                                                            (\x . return (x ==
                                                                            patientToSearchFor))))
      in
    print w sessionUser (liftM show
                           recordsForPatient)

showAuthoredRecordsView :: w:World -> World
showAuthoredRecordsView = \w . 
  let sessionUser = getSessionUser
                      w in
  
  let recordIds = bind sessionUser
   WARNING: cannot abduce a condition for branch
  getRecord w' rid ::
  Tagged Record <_1 == sessionUser _0 && sessionUser _0 == sessionUser w>
  Probable cause: missing condition qualifiers
                 (\user . return
                               (getAuthoredRecordIds w user))
    in
  
  let records = bind recordIds
                  (\rids . mapM (\rid . getRecord
                                          w rid) rids) in
  print w sessionUser (liftM show
                         records)

updateRecordForm :: w:World -> rid:RecordId -> record:Record -> World
updateRecordForm = \w . \rid .
    \record . 
      let w' = setRecord w rid (return
                                  record) in
      
      let newRecord = return
                        defaultRecord in
      
      let u = getSessionUser w' in
      print w' u (liftM show
                    newRecord)

listOfPatientsView :: w:World -> World
listOfPatientsView = \w . 
  let sessionUser = getSessionUser
                      w in
  
  let patients1 = bind sessionUser
                    (\u . bind (downgrade (bind
                                             sessionUser (\x6 . bind
                                                                  (getIsPsychiatrist
                                                                     w x6)
                                                                  (\x5 . return
                                                                           x5))))
                            (\g0 . 
                              if g0
                                then getPsychiatristPatients u
                                else return Nil)) in
  
  let patients2 = bind sessionUser
                    (\u . bind (downgrade (bind
                                             sessionUser (\x13 . bind
                                                                   (getIsDoctor
                                                                      w x13)
                                                                   (\x12 .
                                                                     return
                                                                       x12))))
                            (\g1 . 
                              if g1
                                then getDoctorPatients u
                                else return Nil)) in
  
  let patients = bind patients1
                   (\p1 . bind patients2 (\p2 .
                              return (concat p1 p2))) in
  print w sessionUser (liftM show
                         patients)

(Goals: 5)
(Measures: 4)
(Policy size: fromList [("../paperWrites/Prelude.sq",46),("../paperWrites/Tagged.sq",123),("HealthWeb.sq",194)])
Goal                  &     Templ  &  Solution  &   Time: Typecheck  &     Repair  &    Recheck  &  Total Synth  \\
showRecordByIdView    &        23  &       325  &             0.00s  &      1.51s  &      8.65s  &       10.18s  \\
showRecordsForPatientView  &        56  &       358  &             0.03s  &      2.26s  &      8.90s  &       11.20s  \\
showAuthoredRecordsView  &        45  &        45  &             0.02s  &      0.00s  &      0.00s  &        0.02s  \\
updateRecordForm      &        34  &        32  &             0.00s  &      0.88s  &      0.00s  &        0.89s  \\
listOfPatientsView    &        52  &       108  &             0.04s  &      0.38s  &      0.05s  &        0.48s  \\
Totals                &       210  &       868  &             0.12s  &      5.04s  &     17.61s  &       22.78s  \\
