{-# lifty #-}

{- HotCRP password leak: chair could see other people's passwords in message preview -}

data Store

data Password

-- | Mask a password
mask :: TIO Password <{False}> <{False}> -> TIO Password <{True}> <{False}>

{- Sensitive data and policies -}

-- | User name (public)
getUserName :: ds: Store -> u: User -> TIO String <{True}> <{False}>
   
getUserPassword :: ds: Store -> u: User -> TIO Password <{_0 == u}> <{False}>
-- | User password (only visible to the user)

-- | PC chair (public)
predicate chair :: Store -> User
getChair :: ds: Store -> TIO {User | _v == chair ds} <{True}> <{False}>

redact {mask}

{- Client code -}
  
-- | Send `u` a reminder of their password on behalf on the chair
-- | Repair: in preview, check if u is chair, and otherwise mask the password
sendPasswordReminder :: Store -> User -> TIO Unit <{False}> <{True}>
sendPasswordReminder = \ds . \u .
  do
    ch <- getChair ds
    preview <- liftM2 strcat (getUserName ds u) (liftM show (getUserPassword ds u))
    print ch preview
    
    message <- liftM2 strcat (getUserName ds u) (liftM show (getUserPassword ds u))
    print u message  
