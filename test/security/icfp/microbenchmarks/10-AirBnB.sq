{- AirBnB bug: they scrape phone numbers from user messages, but forgot to do so in the preview  -}

{- Datatypes -}

data MessageId

{- Sensitive data and policies -}

getAllMessageIds :: w: World -> [MessageId]

-- | AirBnB admin
predicate admin :: World -> User
getAdmin :: w: World -> Tagged {User | _v == admin w} <{True}>

-- | Message sender
predicate sender :: World -> Map MessageId User
getSender :: w: World -> m: MessageId -> Tagged {User | _v == (sender w)[[m]] && _v != (recipient w)[[m]]} <{True}>

-- | Message recipient
predicate recipient :: World -> Map MessageId User
getRecipient :: w: World -> m: MessageId -> Tagged {User | _v == (recipient w)[[m]] && _v != (sender w)[[m]]} <{True}>

-- | Message text (only visible to the admin and the sender)
getText :: w: World -> m: MessageId -> Tagged String <{_1 == admin _0 || _1 == (sender _0)[[m]]}>

-- | Scrape phone numbers from the message, making it visible to the recipient
scrapePhoneNumbers :: m: MessageId -> Tagged String <{_1 == admin _0 || _1 == (sender _0)[[m]]}>
                                   -> Tagged String <{_1 == admin _0 || _1 == (sender _0)[[m]] || _1 == (recipient _0)[[m]]}>

redact {scrapePhoneNumbers}

{- Client code -}
  
-- | View all client's messages.
-- | Repair: in viewMessage, check if client is admin (client cannot be sender as per refinement on getRecipient)
--           scraping the message is enough, since we know that client is recipient
viewInbox :: World -> User -> World
viewInbox = \w . \client .
  let viewMessage = \m .
        do to <- getRecipient w m
           if to == client
            then getText w m
            else return emptyString in
  let out = liftM unlines (mapM viewMessage (getAllMessageIds w)) in
  print w (return client) out
  
