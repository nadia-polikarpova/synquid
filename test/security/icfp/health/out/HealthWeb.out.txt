showRecordByIdView :: w:World -> rid:RecordId -> World
showRecordByIdView = \w . \rid .
    
    let u = getSessionUser w in
    
    let record = bind (downgrade
                         (bind u (\x24 . bind (getRecord
                                                 w rid) (\x23 . bind (getAuthor
                                                                        x23)
                                                                  (\x22 . return
                                                                            (eq
                                                                               x24
                                                                               x22))))))
                   (\g0 . bind (downgrade (andM
                                             (bind u (\x36 . bind (getRecord
                                                                     w rid)
                                                               (\x35 . bind
                                                                         (getShouldWithhold
                                                                            x36
                                                                            x35)
                                                                         (\x34 .
                                                                           return
                                                                             (not
                                                                                x34)))))
                                             (bind u (\x37 . getIsDoctor w
                                                               x37)))) (\g1 .
                              bind (downgrade (andM (andM
                                                       (bind u (\x55 . bind
                                                                         (getRecord
                                                                            w
                                                                            rid)
                                                                         (\x54 .
                                                                           bind
                                                                             (getShouldWithhold
                                                                                x55
                                                                                x54)
                                                                             (\x53 .
                                                                               return
                                                                                 (not
                                                                                    x53)))))
                                                       (bind u (\x58 . bind
                                                                         (getRecord
                                                                            w
                                                                            rid)
                                                                         (\x57 .
                                                                           bind
                                                                             (getPatient
                                                                                x57)
                                                                             (\x56 .
                                                                               return
                                                                                 (eq
                                                                                    x58
                                                                                    x56))))))
                                                 (bind u (\x59 . getIsPatient w
                                                                   x59))))
                                (\g2 . bind (downgrade (andM
                                                          (andM (andM (bind u
                                                                         (\x80 .
                                                                           bind
                                                                             (getRecord
                                                                                w
                                                                                rid)
                                                                             (\x79 .
                                                                               bind
                                                                                 (getShouldWithhold
                                                                                    x80
                                                                                    x79)
                                                                                 (\x78 .
                                                                                   return
                                                                                     (not
                                                                                        x78)))))
                                                                   (bind
                                                                      (getRecord
                                                                         w rid)
                                                                      (\x81 .
                                                                        getIsPsychiatricRecord
                                                                          x81)))
                                                             (bind u (\x82 .
                                                                  getIsPsychiatrist
                                                                    w x82)))
                                                          (bind u (\x85 . bind
                                                                            (getRecord
                                                                               w
                                                                               rid)
                                                                            (\x84 .
                                                                              bind
                                                                                (getPatient
                                                                                   x84)
                                                                                (\x83 .
                                                                                  getIsTreating
                                                                                    x85
                                                                                    x83))))))
                                         (\g3 . 
                                           if g0 || (g1 || (g2 || g3))
                                             then getRecord w rid
                                             else removePersonalInfo
                                                    (getRecord w rid))))) in
    print w u (liftM show record)

showRecordsForPatientView :: w:World -> p:User -> World
showRecordsForPatientView = \w .
  \patientToSearchFor . 
    let sessionUser = getSessionUser
                        w in
    
    let recordIds = getAllRecordIds
                      w in
    
    let records = sequence (map
                              (\rid . bind (downgrade (bind
                                                         sessionUser (\x24 .
                                                           bind (getRecord w
                                                                   rid) (\x23 .
                                                               bind (getAuthor
                                                                       x23)
                                                                 (\x22 . return
                                                                           (eq
                                                                              x24
                                                                              x22))))))
                                        (\g0 . bind (downgrade (andM
                                                                  (bind
                                                                     sessionUser
                                                                     (\x36 .
                                                                       bind
                                                                         (getRecord
                                                                            w
                                                                            rid)
                                                                         (\x35 .
                                                                           bind
                                                                             (getShouldWithhold
                                                                                x36
                                                                                x35)
                                                                             (\x34 .
                                                                               return
                                                                                 (not
                                                                                    x34)))))
                                                                  (bind
                                                                     sessionUser
                                                                     (\x37 .
                                                                       getIsDoctor
                                                                         w
                                                                         x37))))
                                                 (\g1 . bind (downgrade (andM
                                                                           (andM
                                                                              (bind
                                                                                 sessionUser
                                                                                 (\x55 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x54 .
                                                                                       bind
                                                                                         (getShouldWithhold
                                                                                            x55
                                                                                            x54)
                                                                                         (\x53 .
                                                                                           return
                                                                                             (not
                                                                                                x53)))))
                                                                              (bind
                                                                                 sessionUser
                                                                                 (\x58 .
                                                                                   bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x57 .
                                                                                       bind
                                                                                         (getPatient
                                                                                            x57)
                                                                                         (\x56 .
                                                                                           return
                                                                                             (eq
                                                                                                x58
                                                                                                x56))))))
                                                                           (bind
                                                                              sessionUser
                                                                              (\x59 .
                                                                                getIsPatient
                                                                                  w
                                                                                  x59))))
                                                          (\g2 . bind (downgrade
                                                                         (andM
                                                                            (andM
                                                                               (andM
                                                                                  (bind
                                                                                     sessionUser
                                                                                     (\x80 .
                                                                                       bind
                                                                                         (getRecord
                                                                                            w
                                                                                            rid)
                                                                                         (\x79 .
                                                                                           bind
                                                                                             (getShouldWithhold
                                                                                                x80
                                                                                                x79)
                                                                                             (\x78 .
                                                                                               return
                                                                                                 (not
                                                                                                    x78)))))
             WARNING: cannot abduce a condition for branch
  getRecord w' rid ::
  Tagged Record <_1 == sessionUser _0 && sessionUser _0 == sessionUser w>
  Probable cause: missing condition qualifiers
                                                                     (bind
                                                                                     (getRecord
                                                                                        w
                                                                                        rid)
                                                                                     (\x81 .
                                                                                       getIsPsychiatricRecord
                                                                                         x81)))
                                                                               (bind
                                                                                  sessionUser
                                                                                  (\x82 .
                                                                                    getIsPsychiatrist
                                                                                      w
                                                                                      x82)))
                                                                            (bind
                                                                               sessionUser
                                                                               (\x85 .
                                                                                 bind
                                                                                   (getRecord
                                                                                      w
                                                                                      rid)
                                                                                   (\x84 .
                                                                                     bind
                                                                                       (getPatient
                                                                                          x84)
                                                                                       (\x83 .
                                                                                         getIsTreating
                                                                                           x85
                                                                                           x83))))))
                                                                   (\g3 . 
                                                                     if g0 ||
                                                                          (g1 ||
                                                                             (g2
                                                                                ||
                                                                                g3))
                                                                       then
                                                                         getRecord
                                                                           w rid
                                                                       else
                                                                         removePersonalInfo
                                                                           (getRecord
                                                                              w
                                                                              rid))))))
                              recordIds) in
    
    let recordsForPatient = bind
                              records (filterM (\record . bind
                                                            (getPatient record)
                                                            (\x . return (x ==
                                                                            patientToSearchFor))))
      in
    print w sessionUser (liftM show
                           recordsForPatient)

showAuthoredRecordsView :: w:World -> World
showAuthoredRecordsView = \w . 
  let sessionUser = getSessionUser
                      w in
  
  let recordIds = bind sessionUser
                    (\user . return
                               (getAuthoredRecordIds w user))
    in
  
  let records = bind recordIds
                  (\rids . mapM (\rid . getRecord
                                          w rid) rids) in
  print w sessionUser (liftM show
                         records)

updateRecordForm :: w:World -> rid:RecordId -> record:Record -> World
updateRecordForm = \w . \rid .
    \record . 
      let w' = setRecord w rid (return
                                  record) in
      
      let newRecord =
        removePersonalInfo (getRecord w'
                              rid) in
      
      let u = getSessionUser w' in
      print w' u (liftM show
                    newRecord)

listOfPatientsView :: w:World -> World
listOfPatientsView = \w . 
  let sessionUser = getSessionUser
                      w in
  
  let patients1 = bind sessionUser
                    (\u . bind (downgrade (bind
                                             sessionUser (\x5 .
                                               getIsPsychiatrist w x5))) (\g0 .
                              
                              if g0
                                then getPsychiatristPatients u
                                else return Nil)) in
  
  let patients2 = bind sessionUser
                    (\u . bind (downgrade (bind
                                             sessionUser (\x11 . getIsDoctor
                                                                   w x11)))
                            (\g1 . 
                              if g1
                                then getDoctorPatients u
                                else return Nil)) in
  
  let patients = bind patients1
                   (\p1 . bind patients2 (\p2 .
                              return (concat p1 p2))) in
  print w sessionUser (liftM show
                         patients)

(Goals: 5)
(Measures: 4)
(Policy size: fromList [("../Prelude.sq",46),("../Tagged.sq",108),("HealthWeb.sq",194)])
Goal                  &     Templ  &  Solution  &   Time: Typecheck  &     Repair  &    Recheck  &  Total Synth  \\
showRecordByIdView    &        23  &       294  &             0.01s  &      1.30s  &      0.38s  &        1.69s  \\
showRecordsForPatientView  &        56  &       327  &             0.01s  &      2.22s  &      0.38s  &        2.63s  \\
showAuthoredRecordsView  &        45  &        45  &             0.01s  &      0.00s  &      0.00s  &        0.01s  \\
updateRecordForm      &        34  &        36  &             0.00s  &      1.11s  &      0.00s  &        1.12s  \\
listOfPatientsView    &        52  &        94  &             0.01s  &      0.04s  &      0.01s  &        0.06s  \\
Totals                &       210  &       796  &             0.06s  &      4.69s  &      0.78s  &        5.54s  \\
